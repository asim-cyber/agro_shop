{% extends "base.html" %}
{% block content %}
<div class="container py-4">
  <div class="row g-4">
    <!-- Left: Product Selection -->
    <div class="col-lg-7 col-md-12">
      <h4 class="mb-3 text-center text-lg-start">ðŸ›’ Products</h4>

      <div class="table-responsive">
        <table class="table table-bordered align-middle text-center shadow-sm" id="productTable">
          <thead class="table-dark">
            <tr>
              <th>Product</th>
              <th>Stock</th>
              <th>Price</th>
              <th>Qty</th>
              <th>Total</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="cartBody"></tbody>
        </table>
      </div>

      <button type="button" class="btn btn-success w-100 mt-2" onclick="addItem()">âž• Add Item</button>
    </div>

    <!-- Right: Invoice Details -->
    <div class="col-lg-5 col-md-12">
      <div class="card shadow-sm border-0 rounded-3">
        <div class="card-body">
          <h4 class="mb-3 text-center text-lg-start">ðŸ§¾ Invoice Details</h4>
          <form method="POST">
            {% csrf_token %}

            <!-- Customer -->
            <div class="mb-3">
              <label class="form-label">Customer</label>
              <select name="customer" class="form-select" required>
                {% for customer in customers %}
                <option value="{{ customer.id }}">{{ customer.name }}</option>
                {% endfor %}
              </select>
            </div>

            <!-- Payment Method -->
            <div class="mb-3">
              <label class="form-label">Payment Method</label>
              <select name="payment_method" class="form-select" required>
                <option value="cash">Cash</option>
                <option value="bank">Bank</option>
              </select>
            </div>

            <!-- Totals -->
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Total Quantity</label>
                <input type="text" id="totalQuantity" name="total_quantity" class="form-control" readonly>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Grand Total</label>
                <input type="text" id="grandTotal" name="grand_total" class="form-control" readonly>
              </div>
            </div>

            <!-- Receiving -->
            <div class="mb-3">
              <label class="form-label">Receiving Amount</label>
              <input type="number" name="receiving_amount" id="receivingAmount" class="form-control" oninput="calculateRemaining()">
            </div>

            <div class="mb-3">
              <label class="form-label">Remaining Amount</label>
              <input type="text" id="remainingAmount" class="form-control" readonly>
            </div>

            <button type="submit" class="btn btn-primary w-100">ðŸ’¾ Create Invoice</button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- âœ… Custom Responsive Styling -->
<style>
  body {
    background-color: #f9f9f9;
  }

  h4 {
    font-weight: 600;
    color: #0f1c2e;
  }

  .table {
    font-size: 0.9rem;
  }

  .btn {
    border-radius: 10px;
  }

  /* Larger screens */
  @media (min-width: 1200px) {
    .container {
      max-width: 1200px;
    }
  }

  /* Medium to Large devices */
  @media (max-width: 992px) {
    .table th, .table td {
      font-size: 0.85rem;
      padding: 6px;
    }
  }

  /* Tablets */
  @media (max-width: 768px) {
    h4 {
      text-align: center;
    }

    .table {
      font-size: 0.8rem;
    }

    .btn {
      font-size: 0.9rem;
    }

    .card {
      margin-top: 1rem;
    }
  }

  /* Mobile devices */
  @media (max-width: 576px) {
    .table {
      font-size: 0.75rem;
    }

    .form-label {
      font-size: 0.85rem;
    }

    input, select {
      font-size: 0.85rem;
      padding: 0.35rem 0.5rem;
    }

    th, td {
      white-space: nowrap;
    }

    #productTable {
      overflow-x: auto;
      display: block;
    }

    .btn {
      padding: 0.5rem;
    }
  }
</style>

<!-- âœ… JavaScript Functions -->
<script>
function addItem() {
  const row = `
    <tr>
      <td>
        <select name="product_id[]" class="form-select" required>
          {% for product in products %}
          <option value="{{ product.id }}">{{ product.name }}</option>
          {% endfor %}
        </select>
      </td>
      <td>Stock</td>
      <td><input type="number" name="price[]" class="form-control" value="0" step="0.01" oninput="updateTotals()"></td>
      <td><input type="number" name="quantity[]" class="form-control" value="1" min="1" oninput="updateTotals()"></td>
      <td class="itemTotal">0.00</td>
      <td><button type="button" class="btn btn-danger btn-sm" onclick="removeRow(this)">X</button></td>
    </tr>`;
  document.getElementById("cartBody").insertAdjacentHTML("beforeend", row);
  updateTotals();
}

function removeRow(btn) {
  btn.closest("tr").remove();
  updateTotals();
}

function updateTotals() {
  let totalQty = 0, grandTotal = 0;
  document.querySelectorAll("#cartBody tr").forEach(row => {
    const qty = parseFloat(row.querySelector("input[name='quantity[]']").value) || 0;
    const price = parseFloat(row.querySelector("input[name='price[]']").value) || 0;
    const total = qty * price;
    row.querySelector(".itemTotal").innerText = total.toFixed(2);
    totalQty += qty;
    grandTotal += total;
  });
  document.getElementById("totalQuantity").value = totalQty;
  document.getElementById("grandTotal").value = grandTotal.toFixed(2);
  calculateRemaining();
}

function calculateRemaining() {
  const receiving = parseFloat(document.getElementById("receivingAmount").value) || 0;
  const grandTotal = parseFloat(document.getElementById("grandTotal").value) || 0;
  const remaining = grandTotal - receiving;
  document.getElementById("remainingAmount").value = remaining.toFixed(2);
}
</script>
{% endblock %}
